<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Translation Test</title>
    <style>
        /* Basic styling - same as before */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; padding: 15px; margin: 0; font-size: 12px; }
        label, input, button { display: block; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        label { font-weight: bold; margin-bottom: 4px; }
        input[type="password"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #0d99ff; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: background-color 0.2s ease; }
        button:hover { background-color: #0b7acc; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 4px; min-height: 30px; word-wrap: break-word; }
        .error-text { color: #d9534f; font-weight: bold; }
        .small-note { font-size: 10px; color: #666; margin-top: -5px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h3>Translation Test</h3>

    <label for="apiKey">DeepL API Key (Free or Pro):</label>
    <input type="password" id="apiKey" placeholder="Paste your DeepL API key here">
    <p class="small-note">Using Free API? Ensure key ends with ':fx'.</p>

    <button id="translateButton">Translate Selected Frame</button>

    <div id="status">Initializing...</div>

  <!-- Keep all the HTML and <style> above this line -->

    <script>
      document.addEventListener('DOMContentLoaded', () => {
          console.log('[UI] DOMContentLoaded fired.');

          const apiKeyInput = document.getElementById('apiKey');
          const translateButton = document.getElementById('translateButton');
          const statusDiv = document.getElementById('status');

          if (!apiKeyInput || !translateButton || !statusDiv) { /* ... Handle UI element missing error ... */ return; }
          console.log('[UI] UI elements found.');

          // No need for currentApiKey variable if not saving/loading

          // --- Status Update Function ---
          function updateStatus(message, isError = false) {
              console.log(`[UI] Status Update: ${message} (Error: ${isError})`);
              if (statusDiv) {
                  statusDiv.textContent = message;
                  statusDiv.className = isError ? 'error-text' : '';
              }
               const processingStates = ['Processing', 'Calling proxy...', 'Applying', 'Loading', 'Saving', 'Requesting translation...']; // Add state
              if (translateButton) {
                  translateButton.disabled = processingStates.some(state => message.includes(state));
              }
          }

          // --- Button Click Handler ---
          translateButton.onclick = () => {
              console.log('[UI] Translate Button Clicked.');
              const apiKeyEntered = apiKeyInput.value.trim();

              if (!apiKeyEntered) {
                  updateStatus('Error: Please enter your DeepL API Key.', true);
                  apiKeyInput.focus();
                  return;
              }

              // --- REMOVED save-api-key message ---

              // Just send the start message with the key directly
              updateStatus('Starting translation...'); // Simpler status
              translateButton.disabled = true;

              console.log('[UI] Sending start-translation-process message to code.ts');
              parent.postMessage({ pluginMessage: { type: 'start-translation-process', apiKey: apiKeyEntered } }, '*');
          };
          console.log('[UI] Button onclick assigned.');


          // --- Listen for messages from code.ts ---
          window.onmessage = async (event) => {
              if (!event.data || !event.data.pluginMessage) return;

              const msg = event.data.pluginMessage;
              console.log('[UI] Message received from code.ts:', msg.type);

              switch (msg.type) {
                  // --- REMOVED Storage Handlers ---
                  // case 'ui-ready-request-key-load':
                  // case 'api-key-loaded':
                  // case 'api-key-load-error':
                  // case 'api-key-save-success':
                  // case 'api-key-save-error':

                  // --- Handle Status Updates From Code ---
                  case 'show-status':
                      console.log('[UI] Received show-status:', msg.message);
                      updateStatus(msg.message, msg.isError || false);
                      break;

                  // --- REMOVED Other Handlers (not needed by UI anymore) ---
                  // case 'texts-extracted-ready-for-api':

                  default:
                      console.log('[UI] Received unhandled message type:', msg.type);
              }
          }; // End window.onmessage

           console.log('[UI] Message listener set up.');

           // Set initial state now that storage isn't involved
           updateStatus('Enter API Key & select frame.');
           translateButton.disabled = false; // Ensure button is enabled initially

      }); // End DOMContentLoaded listener
  </script>

<!-- Keep the closing </body> and </html> tags below this line -->

</body>
</html>